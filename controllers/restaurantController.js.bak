/**
 * Controlador de Restaurantes
 * Maneja CRUD de restaurantes y búsquedas
 */

const { query } = require('../config/database');
const { validateLength, validateRequired } = require('../utils/validator');
const logger = require('../utils/logger');

/**
 * Obtener todos los restaurantes (con filtros opcionales)
 * GET /api/restaurants?search=&cuisine=&minRating=
 */
function getAllRestaurants(req) {
    try {
        const url = new URL(req.url, `http://${req.headers.host}`);
        const searchTerm = url.searchParams.get('search') || '';
        const cuisineType = url.searchParams.get('cuisine') || '';
        const minRating = parseFloat(url.searchParams.get('minRating')) || 0;
        const limit = parseInt(url.searchParams.get('limit')) || 50;
        const offset = parseInt(url.searchParams.get('offset')) || 0;

        let sql = `
            SELECT 
                id,
                name,
                description,
                address,
                phone,
                cuisine_type,
                price_range,
                image_url,
                average_rating,
                total_reviews,
                created_at
            FROM restaurants 
            WHERE is_active = 1
        `;

        const params = [];

        // Filtro de búsqueda
        if (searchTerm) {
            sql += ` AND (name LIKE ? OR description LIKE ? OR address LIKE ?)`;
            const searchPattern = `%${searchTerm}%`;
            params.push(searchPattern, searchPattern, searchPattern);
        }

        // Filtro por tipo de cocina
        if (cuisineType) {
            sql += ` AND cuisine_type = ?`;
            params.push(cuisineType);
        }

        // Filtro por rating mínimo
        if (minRating > 0) {
            sql += ` AND average_rating >= ?`;
            params.push(minRating);
        }

        // Ordenar por rating y fecha
        sql += ` ORDER BY average_rating DESC, created_at DESC`;

        // Paginación
        sql += ` LIMIT ? OFFSET ?`;
        params.push(limit, offset);

        const restaurants = query(sql, params);

        // Obtener total de resultados para paginación
        let countSql = `SELECT COUNT(*) as total FROM restaurants WHERE is_active = 1`;
        const countParams = [];

        if (searchTerm) {
            countSql += ` AND (name LIKE ? OR description LIKE ? OR address LIKE ?)`;
            const searchPattern = `%${searchTerm}%`;
            countParams.push(searchPattern, searchPattern, searchPattern);
        }

        if (cuisineType) {
            countSql += ` AND cuisine_type = ?`;
            countParams.push(cuisineType);
        }

        if (minRating > 0) {
            countSql += ` AND average_rating >= ?`;
            countParams.push(minRating);
        }

        const totalResult = query(countSql, countParams);
        const total = totalResult[0]?.total || 0;

        logger.info('Restaurantes obtenidos', { 
            count: restaurants.length, 
            total,
            filters: { searchTerm, cuisineType, minRating } 
        });

        return {
            success: true,
            statusCode: 200,
            data: {
                restaurants,
                pagination: {
                    total,
                    limit,
                    offset,
                    hasMore: offset + limit < total
                }
            }
        };

    } catch (error) {
        logger.exception(error, { action: 'getAllRestaurants' });
        return {
            success: false,
            statusCode: 500,
            error: 'Error al obtener restaurantes'
        };
    }
}

/**
 * Obtener un restaurante por ID
 * GET /api/restaurants/:id
 */
function getRestaurantById(req, id) {
    try {
        const restaurants = query(`
            SELECT 
                r.*,
                u.first_name as owner_first_name,
                u.last_name as owner_last_name,
                u.email as owner_email
            FROM restaurants r
            LEFT JOIN users u ON r.owner_id = u.id
            WHERE r.id = ? AND r.is_active = 1
        `, [id]);

        if (restaurants.length === 0) {
            return {
                success: false,
                statusCode: 404,
                error: 'Restaurante no encontrado'
            };
        }

        const restaurant = restaurants[0];

        // Obtener reseñas del restaurante
        const reviews = query(`
            SELECT 
                r.id,
                r.rating,
                r.comment,
                r.visit_date,
                r.created_at,
                u.first_name,
                u.last_name,
                u.profile_photo
            FROM reviews r
            JOIN users u ON r.user_id = u.id
            WHERE r.restaurant_id = ? AND r.is_active = 1
            ORDER BY r.created_at DESC
            LIMIT 10
        `, [id]);

        restaurant.recent_reviews = reviews;

        logger.info('Restaurante obtenido', { restaurantId: id });

        return {
            success: true,
            statusCode: 200,
            data: { restaurant }
        };

    } catch (error) {
        logger.exception(error, { action: 'getRestaurantById', id });
        return {
            success: false,
            statusCode: 500,
            error: 'Error al obtener restaurante'
        };
    }
}

/**
 * Crear un nuevo restaurante (solo propietarios)
 * POST /api/restaurants
 */
function createRestaurant(req, body) {
    try {
        const { name, description, address, phone, cuisineType, priceRange, imageUrl } = body;

        // Validaciones
        const nameValidation = validateLength(name, 3, 100, 'Nombre');
        if (!nameValidation.isValid) {
            return {
                success: false,
                statusCode: 400,
                error: nameValidation.error
            };
        }

        const addressValidation = validateRequired(address, 'Dirección');
        if (!addressValidation.isValid) {
            return {
                success: false,
                statusCode: 400,
                error: addressValidation.error
            };
        }

        // Validar price range
        if (priceRange && !['$', '$$', '$$$', '$$$$'].includes(priceRange)) {
            return {
                success: false,
                statusCode: 400,
                error: 'Rango de precio inválido'
            };
        }

        // Verificar que el usuario sea propietario o admin
        if (!req.user || (req.user.role !== 'owner' && req.user.role !== 'admin')) {
            return {
                success: false,
                statusCode: 403,
                error: 'Solo propietarios pueden crear restaurantes'
            };
        }

        // Crear restaurante
        const result = query(`
            INSERT INTO restaurants (
                name, description, address, phone, cuisine_type, 
                price_range, owner_id, image_url
            )
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        `, [
            name,
            description || null,
            address,
            phone || null,
            cuisineType || null,
            priceRange || '$$',
            req.user.id,
            imageUrl || null
        ]);

        const restaurantId = result.lastInsertRowid;

        logger.info('Restaurante creado', { 
            restaurantId, 
            ownerId: req.user.id,
            name 
        });

        return {
            success: true,
            statusCode: 201,
            data: {
                message: 'Restaurante creado exitosamente',
                restaurantId
            }
        };

    } catch (error) {
        logger.exception(error, { action: 'createRestaurant' });
        return {
            success: false,
            statusCode: 500,
            error: 'Error al crear restaurante'
        };
    }
}

/**
 * Actualizar un restaurante (solo el propietario o admin)
 * PUT /api/restaurants/:id
 */
function updateRestaurant(req, id, body) {
    try {
        // Verificar que el restaurante existe
        const restaurants = query('SELECT owner_id FROM restaurants WHERE id = ?', [id]);
        
        if (restaurants.length === 0) {
            return {
                success: false,
                statusCode: 404,
                error: 'Restaurante no encontrado'
            };
        }

        const restaurant = restaurants[0];

        // Verificar permisos (propietario o admin)
        if (req.user.role !== 'admin' && restaurant.owner_id !== req.user.id) {
            return {
                success: false,
                statusCode: 403,
                error: 'No tienes permisos para actualizar este restaurante'
            };
        }

        const { name, description, address, phone, cuisineType, priceRange, imageUrl } = body;

        // Construir UPDATE dinámico
        const updates = [];
        const params = [];

        if (name !== undefined) {
            const validation = validateLength(name, 3, 100, 'Nombre');
            if (!validation.isValid) {
                return { success: false, statusCode: 400, error: validation.error };
            }
            updates.push('name = ?');
            params.push(name);
        }

        if (description !== undefined) {
            updates.push('description = ?');
            params.push(description);
        }

        if (address !== undefined) {
            updates.push('address = ?');
            params.push(address);
        }

        if (phone !== undefined) {
            updates.push('phone = ?');
            params.push(phone);
        }

        if (cuisineType !== undefined) {
            updates.push('cuisine_type = ?');
            params.push(cuisineType);
        }

        if (priceRange !== undefined) {
            if (!['$', '$$', '$$$', '$$$$'].includes(priceRange)) {
                return { success: false, statusCode: 400, error: 'Rango de precio inválido' };
            }
            updates.push('price_range = ?');
            params.push(priceRange);
        }

        if (imageUrl !== undefined) {
            updates.push('image_url = ?');
            params.push(imageUrl);
        }

        if (updates.length === 0) {
            return {
                success: false,
                statusCode: 400,
                error: 'No hay campos para actualizar'
            };
        }

        params.push(id);

        query(`
            UPDATE restaurants 
            SET ${updates.join(', ')}
            WHERE id = ?
        `, params);

        logger.info('Restaurante actualizado', { restaurantId: id, userId: req.user.id });

        return {
            success: true,
            statusCode: 200,
            data: { message: 'Restaurante actualizado exitosamente' }
        };

    } catch (error) {
        logger.exception(error, { action: 'updateRestaurant', id });
        return {
            success: false,
            statusCode: 500,
            error: 'Error al actualizar restaurante'
        };
    }
}

/**
 * Eliminar un restaurante (solo propietario o admin)
 * DELETE /api/restaurants/:id
 */
function deleteRestaurant(req, id) {
    try {
        // Verificar que el restaurante existe
        const restaurants = query('SELECT owner_id FROM restaurants WHERE id = ?', [id]);
        
        if (restaurants.length === 0) {
            return {
                success: false,
                statusCode: 404,
                error: 'Restaurante no encontrado'
            };
        }

        const restaurant = restaurants[0];

        // Verificar permisos
        if (req.user.role !== 'admin' && restaurant.owner_id !== req.user.id) {
            return {
                success: false,
                statusCode: 403,
                error: 'No tienes permisos para eliminar este restaurante'
            };
        }

        // Soft delete
        query('UPDATE restaurants SET is_active = 0 WHERE id = ?', [id]);

        logger.info('Restaurante eliminado', { restaurantId: id, userId: req.user.id });

        return {
            success: true,
            statusCode: 200,
            data: { message: 'Restaurante eliminado exitosamente' }
        };

    } catch (error) {
        logger.exception(error, { action: 'deleteRestaurant', id });
        return {
            success: false,
            statusCode: 500,
            error: 'Error al eliminar restaurante'
        };
    }
}

module.exports = {
    getAllRestaurants,
    getRestaurantById,
    createRestaurant,
    updateRestaurant,
    deleteRestaurant
};
